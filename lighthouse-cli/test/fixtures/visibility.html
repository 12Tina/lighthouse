<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <title>Visibility</title>
  </head>
  <body>
    now you see me
    <script>
      window.addEventListener('visibilitychange', e => console.log(document.visibilityState));

      function waitForVisibilityChange() {
        return new Promise(resolve => window.addEventListener('visibilitychange', function() {
          window.removeEventListener('visibilitychange', this);
          resolve();
        }));
      }

      function waitForFirstPaint() {
        return new Promise((resolve) => {
          const observer = new PerformanceObserver((list) => {
            if (!list.getEntries().length) return;
            observer.disconnect();
            resolve();
          });
          observer.observe({entryTypes: ['paint']});
        });
      }

      async function toggle(openNumTimes) {
        for (let i = 0; i < openNumTimes; i++) {
          const coverWindow = window.open();
          await waitForVisibilityChange();
          coverWindow.close();
          await waitForVisibilityChange();
        }
      }

      async function main() {
        // Avoid NO_FCP, which can happen when tabs are created and steal focus at all the wrong times.
        await waitForFirstPaint();

        const searchParams = new URL(document.location.href).searchParams;
        if (searchParams.has('toggle')) {
          const openNumTimes = parseInt(new URL(document.location.href).searchParams.get('toggle'));
          await toggle(openNumTimes);
        } else if (searchParams.has('hidden')) {
          window.open();
        }
      }

      main();
    </script>
  </body>
</html>
