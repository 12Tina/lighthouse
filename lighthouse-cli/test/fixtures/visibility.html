<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <title>Visibility</title>
  </head>
  <body>
    now you see me
    <script>
      // window.addEventListener('visibilitychange', e => console.log(document.visibilityState));
      function waitForVisibilityChange() {
        return new Promise(resolve => window.addEventListener('visibilitychange', function() {
          window.removeEventListener('visibilitychange', this);
          resolve();
        }));
      }

      async function main(openNumTimes) {
        for (let i = 0; i < openNumTimes; i++) {
          const coverWindow = window.open();
          await waitForVisibilityChange();
          coverWindow.close();
          await waitForVisibilityChange();
        }
      }

      if (document.location.search.includes('open')) {
        const openNumTimes = parseInt(new URL(document.location.href).searchParams.get('open'));
        main(openNumTimes);
      }
    </script>
    <script src="visibility-blocker.js?delay=1000"></script>
    <script src="visibility-blocker.js?delay=1001"></script>
    <script src="visibility-blocker.js?delay=1002"></script>
    <script src="visibility-blocker.js?delay=1003"></script>
    <script src="visibility-blocker.js?delay=1004"></script>
  </body>
</html>
